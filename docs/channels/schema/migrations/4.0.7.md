---
wolfie.headers: explicit architecture with structured clarity for every file.
file.last_modified_system_version: 4.0.14
header_atoms:
  - GLOBAL_CURRENT_LUPOPEDIA_VERSION
  - GLOBAL_CURRENT_AUTHORS
updated: 2026-01-12
author: GLOBAL_CURRENT_AUTHORS
dialog:
  speaker: CURSOR
  target: @everyone
  message: "Created migration documentation for version 4.0.7. This version includes schema alignment fixes, module loader path corrections, error reporting enhancements, new doctrine (AI Uncertainty Expression), URL rewriting configuration, and TRUTH module test data. No database schema changes required - all fixes are code-level corrections to match existing schema."
  mood: "00FF00"
tags:
  categories: ["documentation", "migration", "4.0.7"]
  collections: ["core-docs"]
  channels: ["dev", "release"]
file:
  title: "LUPOPEDIA 4.0.7 — Migration Guide"
  description: "Migration notes and upgrade instructions for version 4.0.7. Includes schema alignment fixes, code corrections, and new features."
  version: GLOBAL_CURRENT_LUPOPEDIA_VERSION
  status: published
  author: GLOBAL_CURRENT_AUTHORS
---

# LUPOPEDIA 4.0.7 — Migration Guide

**Release Date:** 2026-01-12  
**Previous Version:** 4.0.6  
**Migration Type:** Patch (Code Corrections, No Schema Changes)

---

## Overview

Version 4.0.7 is a patch release that fixes schema alignment issues, corrects module loader paths, enhances error reporting, adds new doctrine, and introduces URL rewriting configuration. **No database schema changes are required** - all fixes are code-level corrections to match the existing schema as defined in TOON files.

---

## What Changed

### Fixed

1. **ConnectionsService Schema Alignment**
   - Fixed all 6 methods (`getConnectedAtoms`, `getParentAtoms`, `getChildAtoms`, `getSiblingAtoms`, `getRelatedContent`, `getEdgeTypeSummary`) to use correct column names:
     - Edge columns: `left_object_type`, `left_object_id`, `right_object_type`, `right_object_id` (replaced `source_type`/`source_id`/`target_type`/`target_id`)
     - Weight column: `weight_score` (replaced `weight`)
     - Deletion check: `is_deleted = 0` (replaced `deleted_at IS NULL`)
     - Atom column: `atom_name` (replaced `slug`/`label`)
   - Added table prefixes (`{$table_prefix}`) to all table references
   - Removed unnecessary `edge_types` table joins (using `edge_type` varchar directly)
   - All fixes maintain backward compatibility via column aliases

2. **Module Loader Path Corrections**
   - Fixed incorrect file paths in `lupo-includes/modules/module-loader.php`:
     - `truth-controller.php`: `/modules/truth/` → `/lupo-includes/modules/truth/`
     - `crafty_syntax-controller.php`: `/modules/crafty_syntax/` → `/lupo-includes/modules/crafty_syntax/`
     - `content-controller.php`: `/modules/content/` → `/lupo-includes/modules/content/`
   - Fixed both initial module loading and routing function paths

3. **Error Reporting and Debug Output**
   - Enhanced `index.php` with explicit error reporting at the very top
   - Added comprehensive debug HTML comments for troubleshooting
   - Updated `lupo-includes/bootstrap.php` to remove deprecated `E_STRICT` constant (PHP 8+ compatibility)
   - Improved error display in debug mode with formatted HTML output

### Added

1. **AI Uncertainty Expression Doctrine**
   - New doctrine file: `docs/doctrine/AI_UNCERTAINTY_EXPRESSION_DOCTRINE.md`
   - Ensures all AI agents express uncertainty explicitly when confidence is below threshold
   - Default threshold: 0.75 (DIALOG: 0.25)
   - Prevents authoritative-sounding hallucinations
   - Deterministic, procedural, enforceable

2. **URL Rewriting and Security Configuration**
   - New `.htaccess` file for Apache URL rewriting and security
   - Enables clean URLs (e.g., `/lupopedia/who/captain_wolfie` → `index.php?slug=who/captain_wolfie`)
   - Allows static assets (CSS, JS, images, fonts) to be served directly
   - Blocks PHP files in `lupo-includes/` directory (security)
   - Blocks sensitive directories (`database/`, `config/`, `.git/`)
   - Blocks sensitive file types (`.sql`, `.log`, `.md`, `.yaml`, etc.)
   - Sets security headers (X-Content-Type-Options, X-Frame-Options, X-XSS-Protection)
   - Dynamic `RewriteBase` detection for flexible installation paths

3. **TRUTH Module Test Data**
   - New SQL seed file: `database/install/truth_test_data_captain_wolfie.sql`
   - Inserts content record for "Captain WOLFIE"
   - Inserts question "Who is Captain WOLFIE?" with `qtype='who'` and `slug='captain_wolfie'`
   - Includes `ON DUPLICATE KEY UPDATE` clauses for graceful handling of existing records
   - Includes `INSERT IGNORE` for mapping tables to prevent duplicate errors

4. **Release Readiness Checklist**
   - New checklist file: `docs/RELEASE_READINESS_CHECKLIST_4.0.7.md`
   - Comprehensive checklist for 4.0.7 release validation
   - Covers doctrine compliance, schema alignment, ConnectionsService fixes, TRUTH subsystem integrity, UI/UX stability, changelog, and manual verification

---

## Migration Steps

### Step 1: Backup

1. Backup your database
2. Backup your `lupo-includes/` directory
3. Backup your `config/` directory

### Step 2: Update Files

1. Replace `lupo-includes/class-ConnectionsService.php` with the updated version
2. Replace `lupo-includes/modules/module-loader.php` with the updated version
3. Replace `index.php` with the updated version
4. Replace `lupo-includes/bootstrap.php` with the updated version
5. Add `.htaccess` file to your Lupopedia root directory (if using Apache)
6. Update `config/global_atoms.yaml` version references (or let atom system handle it)

### Step 3: Verify

1. Test all content pages load correctly
2. Test semantic relationships display correctly (references, links, tags, collection)
3. Test TRUTH module routes (`/who/captain_wolfie`, `/truth/{slug}`, etc.)
4. Test module routing (TRUTH, Crafty Syntax, Content)
5. Verify error reporting works in debug mode
6. Verify static assets (CSS, JS, images) load correctly

### Step 4: Optional - Seed Test Data

If you want to test the TRUTH module:

```sql
-- Run the test data seed file
SOURCE database/install/truth_test_data_captain_wolfie.sql;
```

Then test the route: `https://your-domain/lupopedia/who/captain_wolfie`

---

## Database Changes

**None.** This version includes no database schema changes. All fixes are code-level corrections to match the existing schema as defined in TOON files.

---

## Backward Compatibility

- ✅ All changes maintain backward compatibility
- ✅ No breaking changes to APIs or interfaces
- ✅ Column aliases preserve backward compatibility in ConnectionsService
- ✅ Module loader paths corrected but maintain same function signatures
- ✅ Error reporting enhancements are additive (no removal of existing functionality)

---

## Rollback Procedure

If you need to rollback to 4.0.6:

1. Restore `lupo-includes/class-ConnectionsService.php` from backup
2. Restore `lupo-includes/modules/module-loader.php` from backup
3. Restore `index.php` from backup
4. Restore `lupo-includes/bootstrap.php` from backup
5. Remove `.htaccess` file (if added)
6. Restore `config/global_atoms.yaml` version references

**Note:** No database rollback is needed since no schema changes were made.

---

## Known Issues

None at this time.

---

## Support

For issues or questions:
- Check `docs/RELEASE_READINESS_CHECKLIST_4.0.7.md` for verification steps
- Review `CHANGELOG.md` for detailed change list
- Review `dialogs/changelog_dialog.md` for inline dialog entries

---

## Next Steps

After migration:
1. Review the new AI Uncertainty Expression Doctrine
2. Test TRUTH module functionality (if using test data)
3. Verify all semantic relationships display correctly
4. Test URL rewriting (if using `.htaccess`)

---

**Migration Status:** ✅ Ready for Production  
**Risk Level:** Low (Code corrections only, no schema changes)  
**Estimated Downtime:** None (No database changes required)
