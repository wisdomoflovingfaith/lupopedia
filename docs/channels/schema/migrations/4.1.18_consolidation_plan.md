# 4.1.18 — Consolidation Plan

**Date:** 2026-01-20  
**Version:** 4.1.18  
**Status:** Planning only; no schema changes. Execution in 4.1.19+.

---

## Consolidation targets

1. **Dialog system:** lupo_dialog_messages + lupo_dialog_message_bodies
2. **Analytics system:** daily + monthly path/identity/keyword tables
3. **Truth system:** lupo_truth_questions + lupo_truth_answers
4. **Collections system:** lupo_collections + lupo_collection_tabs (hierarchy via parent_id)

---

## Rationale for each merge

### Dialog (messages + bodies)
- Messages and bodies are 1:1 in practice; split adds joins and migration complexity.
- Unified table reduces query count and keeps thread–message–body in one row where appropriate.

### Analytics (daily + monthly)
- Daily and monthly tables share structure; aggregation level can be a column.
- Reduces table count and simplifies reporting and retention logic.

### Truth (questions + answers)
- Questions and answers are tightly coupled; single table with type (question|answer) or parent_id simplifies QA resolution and reduces joins.

### Collections (collections + tabs)
- Tabs are child rows of collections; parent_id on lupo_collections allows hierarchy (or tabs as first-class with collection_id). Consolidation or clearer hierarchy reduces indirection.

---

## Proposed unified table structures (commented)

<!--
unified_dialog_messages:
  id, thread_id, actor_id, body_text, body_html, created_ymdhis, updated_ymdhis, is_deleted, deleted_ymdhis
  (Merge message metadata + body into one row.)

unified_analytics_paths:
  id, path_type, period_type, period_ymd, ...metrics..., created_ymdhis, updated_ymdhis, is_deleted, deleted_ymdhis
  (period_type: 'daily'|'monthly'.)

unified_truth_items:
  id, parent_id, item_type, content, ...; created_ymdhis, updated_ymdhis, is_deleted, deleted_ymdhis
  (item_type: 'question'|'answer'; parent_id links answer→question.)
-->

---

## Execution phases for 4.1.19+

1. **Phase 1 (4.1.19):** Create unified_dialog_messages; migrate from lupo_dialog_messages + lupo_dialog_message_bodies; validate; switch reads; deprecate old tables.
2. **Phase 2 (4.1.20):** Create unified_analytics_paths; migrate daily + monthly; validate; switch; deprecate.
3. **Phase 3 (4.1.21):** Create unified_truth_items; migrate questions + answers; validate; switch; deprecate.
4. **Phase 4 (4.1.22):** ALTER lupo_collections ADD parent_id; backfill; optionally merge lupo_collection_tabs or formalize hierarchy; deprecate if merged.

---

## Risks & mitigations

| Risk | Mitigation |
|------|------------|
| Data loss during merge | Full backup before each phase; INSERT...SELECT with checksums; row-count and spot checks. |
| Application breakage | Feature flags or dual-read during cutover; gradual write cutover; rollback script (revert to old tables). |
| TOON/schema drift | Regenerate TOON after each DDL; run validation and doc updates in same patch. |
| Ordering and dependencies | Execute phases in order; no cross-phase foreign references; document any shared columns. |

---

## Projected table count after consolidation

- **Before (4.1.18):** 173 (after 4.1.17 DROP of 8 legacy).
- **After Phase 1 (dialog):** −1 (messages + bodies → 1 unified).
- **After Phase 2 (analytics):** −2 to −4 depending on scope (daily + monthly merges).
- **After Phase 3 (truth):** −1 (questions + answers → 1).
- **After Phase 4 (collections):** 0 if hierarchy only; −1 if tabs merged into collections.
- **Rough target:** 168–170 tables, subject to final DROP timing and scope.
