---
wolfie.headers: explicit architecture with structured clarity for every file.
file.last_modified_system_version: 4.0.16
header_atoms:
  - GLOBAL_CURRENT_LUPOPEDIA_VERSION
  - GLOBAL_CURRENT_AUTHORS
dialog:
  speaker: CURSOR
  target: @everyone
  mood_RGB: "00FF00"
  message: "Created CHANNEL_DIALOG_AGENT_WORKFLOWS.md to comprehensively document how IDE agents and php_ai_terminal agents interact with channels, dialogs, toon files, and database tables. This document clarifies the dual-storage architecture and fallback behavior for agent coordination."
tags:
  categories: ["documentation", "architecture", "channels", "dialogs", "agents"]
  collections: ["core-docs", "architecture"]
  channels: ["dev", "lupopedia-4.0.16-channels-documentation-database-refinement"]
in_this_file_we_have:
  - IDE Agent Workflows (Filesystem-Based)
  - php_ai_terminal Agent Workflows (Database-Based)
  - Toon Files: Database Schema Reference for IDE Agents
  - Dialog Storage: Filesystem vs Database
  - Fallback Behavior and Agent Coordination
  - Channel System Architecture
  - Database Table Schemas
file:
  title: "Channel and Dialog Agent Workflows"
  description: "Complete documentation of how IDE agents and php_ai_terminal agents interact with channels, dialogs, toon files, and database tables. Defines dual-storage architecture, fallback behavior, and agent coordination patterns."
  version: GLOBAL_CURRENT_LUPOPEDIA_VERSION
  status: published
  author: GLOBAL_CURRENT_AUTHORS
---

# Channel and Dialog Agent Workflows

**Version:** GLOBAL_CURRENT_LUPOPEDIA_VERSION  
**Status:** Published  
**Last Updated:** 2026-01-14

## Overview

Lupopedia maintains a dual-storage architecture for channels and dialogs:

- **IDE Agents** (Cursor, Kiro, Cascade, etc.) use **filesystem-based dialog files** (`dialogs/<channel_name>_dialog.md`)
- **php_ai_terminal Agents** use **database-backed dialog tables** (`lupo_dialog_threads`, `lupo_dialog_messages`)
- **Toon Files** provide IDE agents with lightweight database schema/data references
- **Channels** coordinate multi-agent collaboration contexts

This document defines how each agent type interacts with the channel and dialog systems, including fallback behavior and coordination patterns.

---

## 1. IDE Agent Workflows (Filesystem-Based)

### 1.1 Dialog File Storage

IDE agents write all dialog entries to filesystem-based markdown files:

**Location Pattern:**
```
dialogs/<channel_name>_dialog.md
```

**Examples:**
- `dialogs/changelog_dialog.md` â€” Changelog channel
- `dialogs/routing_changelog.md` â€” Routing development channel
- `dialogs/readme_dialog.md` â€” README documentation channel

### 1.2 Dialog File Format

Dialog files follow this structure:

```markdown
---
wolfie.headers: explicit architecture with structured clarity for every file.
file.last_modified_system_version: 4.0.16
dialog:
  speaker: CURSOR
  target: @everyone
  mood_RGB: "00FF00"
  message: "Dialog entry content here"
---

# Channel Dialog History

## 2026-01-14 â€” Entry Title

**Speaker:** CURSOR  
**Target:** @everyone  
**Mood:** `00FF00`  
**Message:** "Dialog entry content here"

[Additional context, file modifications, etc.]

---
```

### 1.3 Dialog Entry Ordering

**MANDATORY RULE:** Newest entries appear at the top of the file (newest-first ordering).

This ensures:
- Latest context is immediately visible
- Historical entries remain accessible
- File remains readable as it grows

### 1.4 IDE Agent Dialog Writing Requirements

**MANDATORY:** All IDE agents participating in a channel MUST write their dialog entries to the channel's dialog file.

**Example:**
- Channel: `lupopedia 4.0.16 - channels/documentation/database refinement`
- Dialog File: `dialogs/changelog_dialog.md`
- All agents (Cursor, Kiro, Cascade) write to this file

### 1.5 Reading Toon Files (Optional)

IDE agents may read toon files generated from database data for schema reference:

**Toon File Location:**
```
database/toon_data/<table_name>.toon
database/toon_data/<table_name>.txt
```

**Toon File Format:**
- JSON format containing table schema, column definitions, and sample data
- Generated by `database/generate_toon_files.py`
- Provides lightweight database reference without direct database access

**Use Cases:**
- Understanding database table structure
- Referencing column names and types
- Reviewing sample data formats
- Schema validation

**Example Toon File Structure:**
```json
{
    "table_name": "lupo_channels",
    "fields": [
        "`channel_id` bigint NOT NULL auto_increment",
        "`channel_key` varchar(64) NOT NULL COMMENT 'URL-friendly identifier (slug)'",
        ...
    ],
    "data": [
        {
            "channel_id": 0,
            "channel_key": "system/kernel",
            "channel_name": "System Kernel Channel",
            ...
        }
    ],
    "primary_key": {
        "column_name": "channel_id",
        "expected_name": "channel_id",
        "is_correct": true
    }
}
```

### 1.6 Direct Database Access (Optional)

IDE agents may optionally connect directly to the database for:
- Real-time data queries
- Complex joins across tables
- Performance-critical operations

**Note:** Direct database access is optional. Filesystem dialog files remain the primary coordination mechanism.

---

## 2. php_ai_terminal Agent Workflows (Database-Based)

### 2.1 Database Dialog Tables

php_ai_terminal agents use database-backed dialog tables for runtime communication:

**Primary Tables:**
- `lupo_dialog_threads` â€” Thread metadata and context
- `lupo_dialog_messages` â€” Individual messages within threads
- `lupo_dialog_message_bodies` â€” Full long-form message content

### 2.2 Thread Creation

php_ai_terminal agents create threads in `lupo_dialog_threads`:

```sql
INSERT INTO lupo_dialog_threads (
    dialog_thread_id,
    federation_node_id,
    channel_id,
    project_slug,
    task_name,
    created_by_actor_id,
    summary_text,
    status,
    metadata_json,
    created_ymdhis,
    updated_ymdhis
) VALUES (
    :thread_id,
    1,
    :channel_id,
    :project_slug,
    :task_name,
    :actor_id,
    :summary,
    'Open',
    :metadata,
    :created,
    :updated
);
```

### 2.3 Message Creation

php_ai_terminal agents create messages in `lupo_dialog_messages`:

```sql
INSERT INTO lupo_dialog_messages (
    dialog_message_id,
    dialog_thread_id,
    channel_id,
    from_actor_id,
    to_actor_id,
    message_text,
    message_type,
    metadata_json,
    mood_rgb,
    weight,
    created_ymdhis,
    updated_ymdhis
) VALUES (
    :message_id,
    :thread_id,
    :channel_id,
    :from_actor_id,
    :to_actor_id,
    :message_text,
    'text',
    :metadata,
    :mood_rgb,
    1.00,
    :created,
    :updated
);
```

### 2.4 Long-Form Message Bodies

For messages exceeding 1000 characters, php_ai_terminal agents use `lupo_dialog_message_bodies`:

```sql
INSERT INTO lupo_dialog_message_bodies (
    dialog_message_body_id,
    dialog_message_id,
    full_text,
    metadata_json,
    mood_rgb,
    weight,
    created_ymdhis,
    updated_ymdhis
) VALUES (
    :body_id,
    :message_id,
    :full_text,
    :metadata,
    :mood_rgb,
    0.00,
    :created,
    :updated
);
```

### 2.5 Thread Query Patterns

php_ai_terminal agents query threads by:

**By Channel:**
```sql
SELECT * FROM lupo_dialog_threads
WHERE channel_id = :channel_id
  AND is_deleted = 0
ORDER BY created_ymdhis DESC;
```

**By Actor:**
```sql
SELECT * FROM lupo_dialog_threads
WHERE created_by_actor_id = :actor_id
  AND is_deleted = 0
ORDER BY created_ymdhis DESC;
```

**By Status:**
```sql
SELECT * FROM lupo_dialog_threads
WHERE status = :status
  AND is_deleted = 0
ORDER BY created_ymdhis DESC;
```

### 2.6 Message Query Patterns

php_ai_terminal agents query messages by:

**By Thread:**
```sql
SELECT * FROM lupo_dialog_messages
WHERE dialog_thread_id = :thread_id
  AND is_deleted = 0
ORDER BY created_ymdhis ASC;
```

**By Channel:**
```sql
SELECT * FROM lupo_dialog_messages
WHERE channel_id = :channel_id
  AND is_deleted = 0
ORDER BY created_ymdhis ASC;
```

**By Actor (Inbox):**
```sql
SELECT * FROM lupo_dialog_messages
WHERE to_actor_id = :actor_id
  AND is_deleted = 0
ORDER BY created_ymdhis DESC;
```

---

## 3. Toon Files: Database Schema Reference for IDE Agents

### 3.1 Purpose

Toon files provide IDE agents with:
- Database table schema information
- Column definitions and types
- Sample data for format reference
- Migration metadata (primary keys, indexes, constraints)

### 3.2 Generation

Toon files are generated by `database/generate_toon_files.py`:

**Command:**
```bash
python database/generate_toon_files.py [--limit=1000]
```

**Output:**
- `database/toon_data/<table_name>.toon` (JSON format)
- `database/toon_data/<table_name>.txt` (same content, different extension)

### 3.3 Toon File Structure

```json
{
    "table_name": "lupo_channels",
    "fields": [
        "`channel_id` bigint NOT NULL auto_increment",
        "`channel_key` varchar(64) NOT NULL COMMENT 'URL-friendly identifier (slug)'",
        ...
    ],
    "data": [
        {
            "channel_id": 0,
            "channel_key": "system/kernel",
            ...
        }
    ],
    "primary_key": {
        "column_name": "channel_id",
        "expected_name": "channel_id",
        "is_correct": true,
        "needs_rename": false
    },
    "unsigned_columns": [
        {
            "column_name": "channel_id",
            "current_type": "bigint unsigned",
            "expected_type": "bigint",
            "is_primary_key": true
        }
    ],
    "indexes": [
        {
            "index_name": "idx_channel_key",
            "columns": ["channel_key"],
            "is_unique": true,
            "index_type": "BTREE"
        }
    ],
    "unique_constraints": [
        {
            "constraint_name": "uk_channel_key",
            "columns": ["channel_key"]
        }
    ]
}
```

### 3.4 IDE Agent Usage

IDE agents read toon files to:
- Understand database table structure
- Reference column names when writing queries
- Validate schema consistency
- Review migration metadata

**Example:**
```python
# IDE agent reads toon file
with open('database/toon_data/lupo_channels.toon', 'r') as f:
    channel_schema = json.load(f)
    
# Use schema to understand table structure
channel_id_type = channel_schema['fields'][0]  # "`channel_id` bigint NOT NULL auto_increment"
sample_data = channel_schema['data'][0]  # First sample row
```

---

## 4. Dialog Storage: Filesystem vs Database

### 4.1 Dual-Storage Architecture

Lupopedia maintains two parallel dialog storage systems:

| Aspect | IDE Agents | php_ai_terminal Agents |
|--------|------------|------------------------|
| **Storage** | Filesystem (`dialogs/*_dialog.md`) | Database (`lupo_dialog_*` tables) |
| **Format** | Markdown with WOLFIE headers | SQL tables with JSON metadata |
| **Ordering** | Newest-first in file | Timestamp-based queries |
| **Access** | File read/write | SQL queries |
| **Coordination** | Channel-level collaboration | Thread-level conversations |

### 4.2 Channel Dialog Files (IDE Agents)

**Purpose:** Multi-agent collaboration contexts

**Storage:** `dialogs/<channel_name>_dialog.md`

**Characteristics:**
- Multiple agents participate
- Newest-first ordering
- WOLFIE header integration
- Markdown format
- Human-readable

**Example:**
```
dialogs/changelog_dialog.md
dialogs/routing_changelog.md
dialogs/readme_dialog.md
```

### 4.3 Database Dialog Tables (php_ai_terminal Agents)

**Purpose:** Runtime thread conversations

**Storage:** `lupo_dialog_threads`, `lupo_dialog_messages`

**Characteristics:**
- One-on-one or small group conversations
- Timestamp-based ordering
- SQL query access
- JSON metadata support
- Programmatic access

**Example:**
```sql
-- Thread metadata
lupo_dialog_threads (dialog_thread_id, channel_id, project_slug, task_name, ...)

-- Messages
lupo_dialog_messages (dialog_message_id, dialog_thread_id, from_actor_id, to_actor_id, ...)
```

### 4.4 Relationship Between Systems

**Channels** bridge both systems:
- IDE agents write channel dialog entries to filesystem files
- php_ai_terminal agents may reference channels via `channel_id` in database tables
- Both systems use the same channel definitions from `lupo_channels` table

**Threads** are database-only:
- Threads exist only in `lupo_dialog_threads` table
- IDE agents do not create threads (they use channel dialog files)
- php_ai_terminal agents create threads for runtime conversations

---

## 5. Fallback Behavior and Agent Coordination

### 5.1 IDE Agent Fallback Hierarchy

IDE agents follow this fallback hierarchy:

1. **Primary:** Read/write to `dialogs/<channel_name>_dialog.md` (MANDATORY)
2. **Optional:** Read from `database/toon_data/<table_name>.toon` (schema reference)
3. **Optional:** Connect directly to database (real-time queries)
4. **Required Fallback:** MUST be able to write to filesystem dialog files

### 5.2 php_ai_terminal Agent Fallback Hierarchy

php_ai_terminal agents follow this fallback hierarchy:

1. **Primary:** Read/write to `lupo_dialog_*` database tables
2. **Optional:** Read channel definitions from `lupo_channels` table
3. **Optional:** Reference actor information from `lupo_actors` table
4. **Required Fallback:** MUST be able to write to database dialog tables

### 5.3 Cross-System Coordination

**Channel Coordination:**
- IDE agents write channel dialog entries to filesystem
- php_ai_terminal agents may read channel definitions from database
- Both systems reference the same `lupo_channels` table

**Actor Coordination:**
- Both systems reference `lupo_actors` table for actor information
- IDE agents may read actor data from toon files
- php_ai_terminal agents query actor data directly from database

**Dialog Coordination:**
- IDE agents coordinate via filesystem dialog files
- php_ai_terminal agents coordinate via database dialog tables
- Both systems maintain separate but complementary dialog histories

---

## 6. Channel System Architecture

### 6.1 Channel Definition Tables

**`lupo_channels`** â€” Channel definitions:

| Column | Type | Description |
|--------|------|-------------|
| `channel_id` | BIGINT | Primary key |
| `channel_key` | VARCHAR(64) | URL-friendly identifier (slug) |
| `channel_name` | VARCHAR(255) | Human-readable name |
| `description` | TEXT | Channel description |
| `metadata_json` | TEXT | JSON metadata |
| `status_flag` | TINYINT | 1=active, 0=inactive |
| `created_ymdhis` | BIGINT | Creation timestamp |
| `updated_ymdhis` | BIGINT | Last update timestamp |

**`lupo_actor_channels`** â€” Actor-channel relationships:

| Column | Type | Description |
|--------|------|-------------|
| `actor_channel_id` | BIGINT | Primary key |
| `actor_id` | BIGINT | Reference to actor |
| `channel_id` | BIGINT | Reference to channel |
| `status` | CHAR(1) | A=Active, I=Inactive |
| `bg_color` | VARCHAR(6) | Background color (hex) |
| `text_color` | VARCHAR(6) | Text color (hex) |
| `last_read_ymdhis` | BIGINT | Last read timestamp |
| `preferences_json` | JSON | UI/UX preferences |

**`lupo_actor_channel_roles`** â€” Role assignments:

| Column | Type | Description |
|--------|------|-------------|
| `actor_channel_role_id` | BIGINT | Primary key |
| `actor_id` | BIGINT | Reference to actor |
| `channel_id` | BIGINT | Reference to channel |
| `role_key` | VARCHAR(64) | Role identifier |

### 6.2 Channel Naming Conventions

**Database:** `channel_key` (slug format)
- Examples: `system/kernel`, `system/lobby`, `dev/documentation`

**Filesystem:** `dialogs/<channel_name>_dialog.md`
- Examples: `dialogs/changelog_dialog.md`, `dialogs/routing_changelog.md`

**Mapping:** Channel names in filesystem may differ from `channel_key` in database, but both reference the same logical channel.

### 6.3 Channel Examples

**System Channels:**
- Channel 0: `system/kernel` â€” System kernel channel
- Channel 1: `system/lobby` â€” Universal entry point

**Development Channels:**
- `dev/documentation` â€” Documentation development
- `dev/routing` â€” Routing subsystem development
- `dev/database` â€” Database refinement

---

## 7. Database Table Schemas

### 7.1 Dialog Threads Table

**Table:** `lupo_dialog_threads`

**Purpose:** High-level dialog threads grouping messages across agents, tasks, and projects.

**Key Columns:**
- `dialog_thread_id` â€” Primary key
- `channel_id` â€” Optional channel identifier
- `project_slug` â€” Project or subsystem identifier
- `task_name` â€” Human-readable task name
- `created_by_actor_id` â€” Agent or human who initiated thread
- `status` â€” Thread lifecycle state (Open, Ongoing, Closed, Archived)
- `metadata_json` â€” Metadata: intent, scope, persona, mood

### 7.2 Dialog Messages Table

**Table:** `lupo_dialog_messages`

**Purpose:** Individual messages within dialog threads.

**Key Columns:**
- `dialog_message_id` â€” Primary key
- `dialog_thread_id` â€” Thread grouping
- `channel_id` â€” Optional channel identifier
- `from_actor_id` â€” Sender actor ID
- `to_actor_id` â€” Recipient actor ID
- `message_text` â€” Message content (up to 1000 chars)
- `message_type` â€” Type: text, command, system, error
- `mood_rgb` â€” Mood color (6-char hex)
- `metadata_json` â€” Additional message metadata

### 7.3 Dialog Message Bodies Table

**Table:** `lupo_dialog_message_bodies`

**Purpose:** Full long-form message content for messages exceeding 1000 characters.

**Key Columns:**
- `dialog_message_body_id` â€” Primary key
- `dialog_message_id` â€” Reference to message
- `full_text` â€” Full long-form message content
- `metadata_json` â€” Message body metadata
- `mood_rgb` â€” Mood color (6-char hex)

---

## 8. Summary

### 8.1 IDE Agents

- **Write to:** `dialogs/<channel_name>_dialog.md` (MANDATORY)
- **Read from:** Toon files (optional), database (optional)
- **Coordination:** Channel-level collaboration via filesystem dialog files
- **Format:** Markdown with WOLFIE headers, newest-first ordering

### 8.2 php_ai_terminal Agents

- **Write to:** `lupo_dialog_*` database tables (MANDATORY)
- **Read from:** Database tables via SQL queries
- **Coordination:** Thread-level conversations via database tables
- **Format:** SQL tables with JSON metadata, timestamp-based ordering

### 8.3 Toon Files

- **Purpose:** Database schema reference for IDE agents
- **Location:** `database/toon_data/<table_name>.toon`
- **Format:** JSON with table schema, columns, sample data, migration metadata
- **Generation:** `database/generate_toon_files.py`

### 8.4 Channels

- **Storage:** `lupo_channels` table (definitions)
- **Relationships:** `lupo_actor_channels`, `lupo_actor_channel_roles`
- **Filesystem:** `dialogs/<channel_name>_dialog.md` (IDE agent coordination)
- **Database:** `channel_id` references in dialog tables (php_ai_terminal agents)

---

## Related Documentation

- **[DIALOGS_AND_CHANNELS.md](DIALOGS_AND_CHANNELS.md)** â€” Thread vs channel distinction
- **[DIALOG_DOCTRINE.md](../../doctrine/DIALOG_DOCTRINE.md)** â€” Dialog system doctrine
- **[CHANNEL_DOCTRINE.md](../../doctrine/CHANNEL_DOCTRINE.md)** â€” Channel doctrine
- **[database/generate_toon_files.py](../../database/generate_toon_files.py)** â€” Toon file generator
- **[database/toon_data/](../../database/toon_data/)** â€” Toon file storage

---

*Last Updated: January 14, 2026*  
*Version: GLOBAL_CURRENT_LUPOPEDIA_VERSION*  
*Status: Published*  
*Author: GLOBAL_CURRENT_AUTHORS*
