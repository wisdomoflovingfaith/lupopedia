---
wolfie.headers: explicit architecture with structured clarity for every file.
file.last_modified_system_version: 4.0.26
header_atoms:
  - GLOBAL_CURRENT_LUPOPEDIA_VERSION
  - GLOBAL_CURRENT_AUTHORS
dialog:
  speaker: CURSOR
  target: @everyone
  mood_RGB: "00FF00"
  message: "Created migration guide for version 4.0.26 - Version synchronization and migration preparation. Updated all version anchors to 4.0.26, created SQL doctrine tab mapping migration, refined migration pattern for unique constraint safety, and ensured system consistency. Migrations ready for execution phase."
tags:
  categories: ["documentation", "migration", "4.0.26"]
  collections: ["core-docs"]
  channels: ["dev", "release"]
file:
  title: "LUPOPEDIA 4.0.26 — Migration Guide"
  description: "Migration notes and upgrade instructions for version 4.0.26. Includes version synchronization, SQL doctrine tab mapping migration preparation, and migration pattern refinements."
  version: GLOBAL_CURRENT_LUPOPEDIA_VERSION
  status: published
  author: GLOBAL_CURRENT_AUTHORS
---

# LUPOPEDIA 4.0.26 — Migration Guide

**Release Date:** 2026-01-15  
**Previous Version:** 4.0.25  
**Migration Type:** Patch (Version Sync & Migration Preparation)

---

## Overview

Version 4.0.26 is a **version synchronization and migration preparation** patch. This version updates all version references to 4.0.26, creates SQL doctrine tab mapping migration ready for execution, refines migration patterns for unique constraint safety, and ensures system consistency across all version anchors.

---

## What Changed

### Added

1. **SQL Doctrine Tab Mapping Migration** (`database/migrations/doctrine_sql_tab_mapping_4_0_25.sql`)
   - Created migration to map 7 SQL doctrine files to `doctrine.sql` tab (tab 11)
   - Mappings include:
     - `doctrine-sql-refactor-mapping-doctrine` (sort_order: 1)
     - `doctrine-sql-rewrite-doctrine` (sort_order: 2)
     - `doctrine-sql-type-doctrine` (sort_order: 3)
     - `doctrine-no-foreign-keys-doctrine` (sort_order: 4)
     - `doctrine-no-stored-procedures-doctrine` (sort_order: 5)
     - `doctrine-no-triggers-doctrine` (sort_order: 6)
     - `doctrine-pdo-conversion-doctrine` (sort_order: 7)
   - Migration uses safe three-step pattern (soft-delete → update → insert) for unique constraint handling
   - Migration is idempotent and ready for execution

### Changed

1. **Version Atom** (`config/global_atoms.yaml`)
   - Updated `GLOBAL_CURRENT_LUPOPEDIA_VERSION` from `"4.0.25"` to `"4.0.26"`
   - Updated `versions.lupopedia` from `"4.0.25"` to `"4.0.26"`
   - Updated `versions.crafty_syntax` from `"4.0.25"` to `"4.0.26"`
   - Updated `versions.wolfie_headers` from `"4.0.25"` to `"4.0.26"`
   - Updated `versions.schema` from `"4.0.25"` to `"4.0.26"`

2. **Version Constants** (`lupo-includes/version.php`)
   - Updated `LUPOPEDIA_VERSION` constant from `'4.0.25'` to `'4.0.26'`
   - Updated `LUPOPEDIA_DB_VERSION` constant from `'4.0.25'` to `'4.0.26'`
   - Updated `LUPOPEDIA_VERSION_NUM` constant from `40025` to `40026`
   - Updated `@version` docblock from `4.0.25` to `4.0.26`

3. **Changelog** (`CHANGELOG.md`)
   - Added new section for version 4.0.26
   - Updated WOLFIE header `file.last_modified_system_version` to `4.0.26`
   - Documented SQL doctrine tab mapping migration creation
   - Documented migration pattern refinements

4. **Dialog Log** (`dialogs/changelog_dialog.md`)
   - Added new dialog entry for version 4.0.26
   - Documented version synchronization work
   - Documented migration preparation status

5. **Orchestrator Doctrine** (`docs/doctrine/ORCHESTRATOR_DOCTRINE.md`)
   - Updated `file.last_modified_system_version` to `4.0.26`
   - Updated version footer to `4.0.26`

6. **Migration Pattern Refinement**
   - Refined SQL migration pattern for safe unique constraint handling
   - Improved UPDATE/INSERT pattern to explicitly check target tab in NOT EXISTS clauses
   - Ensured migrations are fully idempotent and safe for multiple executions

---

## Migration Steps

### Step 1: Backup

1. Backup your version configuration files:
   - `config/global_atoms.yaml`
   - `lupo-includes/version.php`

2. Backup your documentation files:
   - `CHANGELOG.md`
   - `dialogs/changelog_dialog.md`
   - `docs/doctrine/ORCHESTRATOR_DOCTRINE.md`

3. Backup your migration files:
   - `database/migrations/doctrine_sql_tab_mapping_4_0_25.sql` (if exists)

### Step 2: Update Files

1. **Version Configuration** - Update version references:
   - `config/global_atoms.yaml` - Update version atom and versions section
   - `lupo-includes/version.php` - Update version constants

2. **Documentation** - Update version references:
   - `CHANGELOG.md` - Add new version section
   - `dialogs/changelog_dialog.md` - Add new dialog entry
   - `docs/doctrine/ORCHESTRATOR_DOCTRINE.md` - Update header version
   - `docs/migrations/4.0.26.md` - Create migration guide (this file)

3. **WOLFIE Headers** - Update headers in modified files:
   - Update `file.last_modified_system_version` to `4.0.26`
   - Update `wolfie.headers.version` to `4.0.26` (literal string, not atom)

### Step 3: Verify Version

1. **Check Version Atom**:
   - Verify `GLOBAL_CURRENT_LUPOPEDIA_VERSION` in `config/global_atoms.yaml` is `"4.0.26"`

2. **Check Version Constants**:
   - Verify `LUPOPEDIA_VERSION` in `lupo-includes/version.php` is `'4.0.26'`
   - Verify `LUPOPEDIA_VERSION_NUM` is `40026`

3. **Check Documentation**:
   - Verify `CHANGELOG.md` includes 4.0.26 section
   - Verify migration guide exists at `docs/migrations/4.0.26.md`
   - Verify dialog log includes 4.0.26 entry

### Step 4: Execute Migrations (When Ready)

1. **Orchestrator Schema Migration**:
   - Execute `database/migrations/orchestrator_schema_4_0_25.sql`
   - Creates `lupopedia_orchestration` schema with 5 tables
   - Verifies schema creation and table structure

2. **Ephemeral Schema Migration**:
   - Execute `database/migrations/ephemeral_schema_4_0_25.sql`
   - Creates `lupopedia_ephemeral` schema with 5 tables
   - Verifies schema creation and table structure

3. **SQL Doctrine Tab Mapping Migration**:
   - Execute `database/migrations/doctrine_sql_tab_mapping_4_0_25.sql`
   - Maps 7 SQL doctrine files to `doctrine.sql` tab (tab 11)
   - Verifies mappings created correctly with verification query

4. **Regenerate TOON Files**:
   - Run TOON file generation script after migrations
   - Verify TOON files reflect new schema structures
   - Verify tab mappings are reflected in TOON data

---

## Database Changes

### Pending Migrations (Ready for Execution)

1. **Orchestrator Schema** (`orchestrator_schema_4_0_25.sql`)
   - Creates `lupopedia_orchestration` schema
   - Creates 5 orchestration tables:
     - `lupo_migration_tracking`
     - `lupo_schema_versions`
     - `lupo_table_classifications`
     - `lupo_migration_states`
     - `lupo_migration_validations`

2. **Ephemeral Schema** (`ephemeral_schema_4_0_25.sql`)
   - Creates `lupopedia_ephemeral` schema
   - Creates 5 ephemeral tables:
     - `lupo_sessions`
     - `lupo_cache`
     - `lupo_temp_data`
     - `lupo_job_queue`
     - `lupo_locks`

3. **SQL Doctrine Tab Mapping** (`doctrine_sql_tab_mapping_4_0_25.sql`)
   - Maps 7 SQL doctrine content items to `doctrine.sql` tab (tab 11)
   - Uses safe three-step pattern for unique constraint handling
   - Idempotent and safe for multiple executions

**Note:** These migrations are ready but not yet executed. Execute them when ready to deploy the orchestrator subsystem and complete SQL doctrine tab mapping.

---

## Component Details

### Version Atom (`GLOBAL_CURRENT_LUPOPEDIA_VERSION`)
- **Location**: `config/global_atoms.yaml`
- **Purpose**: Single source of truth for Lupopedia version
- **Usage**: Referenced in WOLFIE headers via `GLOBAL_CURRENT_LUPOPEDIA_VERSION` atom
- **Updated**: From `"4.0.25"` to `"4.0.26"`

### Version Constants (`lupo-includes/version.php`)
- **Location**: `lupo-includes/version.php`
- **Purpose**: PHP constants for version checking and comparison
- **Updated Constants**:
  - `LUPOPEDIA_VERSION`: `'4.0.25'` → `'4.0.26'`
  - `LUPOPEDIA_DB_VERSION`: `'4.0.25'` → `'4.0.26'`
  - `LUPOPEDIA_VERSION_NUM`: `40025` → `40026`

### SQL Doctrine Tab Mapping Migration (`doctrine_sql_tab_mapping_4_0_25.sql`)
- **Location**: `database/migrations/doctrine_sql_tab_mapping_4_0_25.sql`
- **Purpose**: Maps SQL doctrine content files to `doctrine.sql` tab
- **Pattern**: Safe three-step pattern (soft-delete → update → insert)
- **Status**: Ready for execution (idempotent and safe)

---

## Migration Pattern Refinements

### Unique Constraint Handling

**Previous Pattern Issues:**
- UPDATE statements could attempt to update rows already on target tab
- INSERT statements checked for any active mapping, not specifically target tab mapping
- Could cause duplicate key violations on `unique_item_in_tab` constraint

**Refined Pattern:**
1. **Soft-Delete Step**: Soft-delete mappings on OTHER tabs (excludes target tab)
2. **Update Step**: Update existing mapping on target tab if it exists (sets sort_order, ensures is_deleted = 0)
3. **Insert Step**: Insert only if no active mapping to target tab exists (explicit target tab check)

**Benefits:**
- Fully idempotent (safe for multiple executions)
- Handles unique constraint correctly
- Prevents duplicate mappings
- Safe for concurrent execution

---

## Backward Compatibility

- ✅ **Fully backward compatible** with 4.0.25
- ✅ **No breaking changes** - Version bump and migration preparation only
- ✅ **No functional changes** - All behavior identical to 4.0.25
- ✅ **Legacy files preserved** - All compatibility shims maintained
- ✅ **Database unchanged** - Migrations ready but not executed (no schema changes until migrations run)
- ✅ **API endpoints unchanged** - Existing endpoints continue to work

---

## Rollback Procedure

If you need to rollback to 4.0.25:

1. Restore version configuration files from backup:
   - `config/global_atoms.yaml`
   - `lupo-includes/version.php`

2. Restore documentation files from backup:
   - `CHANGELOG.md`
   - `dialogs/changelog_dialog.md`
   - `docs/doctrine/ORCHESTRATOR_DOCTRINE.md`
   - Remove `docs/migrations/4.0.26.md` (if created)

3. Restore WOLFIE headers in modified files:
   - Update `file.last_modified_system_version` back to `4.0.25`
   - Update `wolfie.headers.version` back to `4.0.25`

4. Remove migration file (if not executed):
   - `database/migrations/doctrine_sql_tab_mapping_4_0_25.sql`

**Note:** If migrations have been executed, rollback requires:
- Dropping `lupopedia_orchestration` and `lupopedia_ephemeral` schemas (if created)
- Removing SQL doctrine tab mappings (if created)
- Regenerating TOON files

---

## Known Issues

None at this time.

---

## Support

For issues or questions:
- Review this migration guide for version update details
- Check `CHANGELOG.md` for complete change list
- Verify version constants match version atom
- Check WOLFIE headers for correct version references
- Review migration files before execution

---

## Next Steps

After version update:
1. Verify version atom is correctly updated
2. Verify version constants match version atom
3. Test version checking functions if used in your code
4. Review migration files before execution
5. Execute migrations when ready:
   - Orchestrator schema migration
   - Ephemeral schema migration
   - SQL doctrine tab mapping migration
6. Regenerate TOON files after migrations
7. Verify system consistency

---

**Migration Status:** ✅ Ready for Production  
**Risk Level:** None (Version bump and migration preparation only, no functional changes)  
**Estimated Downtime:** None (No database changes until migrations are executed)

---

*Last Updated: January 15, 2026*  
*Version: 4.0.26*  
*Status: Published*  
*Author: GLOBAL_CURRENT_AUTHORS*
