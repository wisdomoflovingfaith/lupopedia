---
wolfie.headers: explicit architecture with structured clarity for every file.
file.last_modified_system_version: 4.0.18
header_atoms:
  - GLOBAL_CURRENT_LUPOPEDIA_VERSION
  - GLOBAL_CURRENT_AUTHORS
dialog:
  speaker: CURSOR
  target: @everyone
  mood_RGB: "00FF00"
  message: "Created migration guide for version 4.0.18 - UI Layout Template Integration. Updated main layout to match template structure, moved Collections dropdown to topbar, fixed tab counting and routing. No schema changes or breaking changes."
tags:
  categories: ["documentation", "migration", "4.0.18"]
  collections: ["core-docs"]
  channels: ["dev", "release"]
file:
  title: "LUPOPEDIA 4.0.18 — Migration Guide"
  description: "Migration notes and upgrade instructions for version 4.0.18. Includes UI layout template integration, Collections dropdown component, and routing improvements."
  version: GLOBAL_CURRENT_LUPOPEDIA_VERSION
  status: published
  author: GLOBAL_CURRENT_AUTHORS
---

# LUPOPEDIA 4.0.18 — Migration Guide

**Release Date:** 2026-01-15  
**Previous Version:** 4.0.17  
**Migration Type:** Patch (UI Integration & Routing)

---

## Overview

Version 4.0.18 is a patch release focused on **UI layout template integration** and **routing improvements**. This version updates the main layout to match the template structure, integrates a Collections dropdown component into the topbar navigation, fixes tab counting issues, and improves routing for collection tabs containing content items.

---

## What Changed

### Added

1. **Collections Dropdown Component** (`lupo-includes/ui/components/collections_dropdown.php`)
   - New component for selecting and managing user collections
   - Lists collections via AJAX from `api/list_user_collections.php`
   - Includes Save/Load/Edit actions as dropdown menu options
   - Triggers tab loading when collection is selected
   - Styled to match topbar navigation links

2. **Content Controller Collection Tab Handler** (`content_handle_collection_tab()`)
   - New function in `lupo-includes/modules/content/content-controller.php`
   - Handles `/collection/{id}/tab/{slug}` routes for content items
   - Loads content items from `lupo_collection_tab_map` where `item_type = 'content'`
   - Renders content list with proper navigation context
   - Ensures tabs with content items route correctly (not just TRUTH items)

3. **API Endpoint** (`api/list_user_collections.php`)
   - Returns list of collections accessible to current user
   - Supports both logged-in users (from `lupo_actor_collections`) and public collections
   - Returns collection metadata (id, name, description, slug)

### Changed

1. **Main Layout Template** (`lupo-includes/ui/layouts/main_layout.php`)
   - Updated to match `template.htm` structure
   - Implemented decorative border frame system (9-part border around content area)
   - Integrated Collections dropdown into topbar navigation (after "Agents" link)
   - Added AJAX-loaded collection tabs in saved-collections-nav area
   - Added bottom action bar with navigation icons (prev, references, context, hashtag, share, like, comment, links, folder, atoms, next)
   - Added shortcut dropdown and contents dropdown in top border
   - Moved Save/Load/Edit collection actions to Collections dropdown menu
   - Removed side panels (semantic map, content outline) from layout

2. **Topbar Navigation** (`lupo-includes/ui/components/topbar.php`)
   - Removed static "Collections" link (replaced by Collections dropdown)
   - Integrated Collections dropdown component into navigation bar
   - Updated active link detection to remove collections check

3. **Collection Tabs Loader** (`lupo-includes/functions/collection-tabs-loader.php`)
   - Updated `load_collection_tabs()` to load child tabs from database
   - Now loads root-level tabs AND their child tabs from `lupo_collection_tabs`
   - Uses `collection_tab_parent_id` to find child tabs
   - Properly counts child tabs (excluding `_slug` metadata key)
   - Stores children in array structure: `['_slug' => 'tab-slug', 'Sub Tab 1', 'Sub Tab 2', ...]`

4. **Module Router** (`lupo-includes/modules/module-loader.php`)
   - Updated routing priority for `/collection/{id}/tab/{slug}` routes
   - Content controller now handles collection tab routes first
   - Falls back to TRUTH controller if content controller doesn't handle the route
   - Ensures content items in tabs route correctly (not just TRUTH items)

### Fixed

1. **Tab Count Display** - Fixed issue where all tabs showed "0" elements:
   - Updated `load_collection_tabs()` to load child tabs from database using `collection_tab_parent_id`
   - Fixed count calculation in `main_layout.php` to exclude `_slug` metadata key
   - Updated JavaScript tab loading to count children correctly

2. **Collection Tab Routing** - Fixed routing issue where `/collection/3/tab/misc-doctrine` was routing to TRUTH instead of content:
   - Created `content_handle_collection_tab()` function in content controller
   - Updated router to try content controller first, then TRUTH controller
   - Ensures tabs with content items route correctly

---

## Migration Steps

### Step 1: Backup

1. Backup your UI layout files:
   - `lupo-includes/ui/layouts/main_layout.php`
   - `lupo-includes/ui/components/topbar.php`
   - `lupo-includes/ui/components/collections_dropdown.php` (if exists)

2. Backup your routing files:
   - `lupo-includes/modules/module-loader.php`
   - `lupo-includes/modules/content/content-controller.php`

3. Backup your function files:
   - `lupo-includes/functions/collection-tabs-loader.php`

### Step 2: Update Files

1. **New Component** - Add Collections dropdown component:
   - `lupo-includes/ui/components/collections_dropdown.php` (new file)

2. **Updated Components** - Update existing files:
   - `lupo-includes/ui/layouts/main_layout.php` (major update)
   - `lupo-includes/ui/components/topbar.php` (removed Collections link, added dropdown)
   - `lupo-includes/modules/module-loader.php` (routing priority update)
   - `lupo-includes/modules/content/content-controller.php` (new function)
   - `lupo-includes/functions/collection-tabs-loader.php` (child tabs loading)

3. **API Endpoint** - Ensure API endpoint exists:
   - `api/list_user_collections.php` (should already exist from previous work)

### Step 3: Verify Integration

1. **Test Collections Dropdown**:
   - Open topbar navigation
   - Click "Collections" dropdown (after "Agents")
   - Verify collections list loads via AJAX
   - Test Save/Load/Edit actions

2. **Test Tab Loading**:
   - Select a collection from dropdown
   - Verify tabs load in saved-collections-nav area
   - Verify tab counts display correctly (not "0")
   - Test clicking tabs to navigate

3. **Test Routing**:
   - Navigate to `/collection/3/tab/misc-doctrine`
   - Verify it routes to content controller (not TRUTH)
   - Verify content list displays correctly

### Step 4: Validate Layout

1. **Visual Testing**:
   - Verify decorative border frame displays correctly
   - Check bottom action bar icons are visible
   - Verify shortcut and contents dropdowns work
   - Test responsive design on mobile devices

2. **Functional Testing**:
   - All dropdown menus work correctly
   - Tab navigation functions properly
   - Collection selection triggers tab loading
   - Save/Load/Edit modals function correctly

---

## Database Changes

**None.** This version includes no database schema changes. All changes are UI integration, component updates, and routing improvements using existing database structures.

---

## Component Details

### Collections Dropdown Component (`collections_dropdown.php`)
- **Location**: `lupo-includes/ui/components/collections_dropdown.php`
- **Features**: 
  - Lists user collections via AJAX
  - Highlights currently selected collection
  - Includes Save/Load/Edit actions as menu options
  - Triggers tab loading on collection selection
- **JavaScript**: `selectCollection()`, `loadCollectionTabs()`, `checkLoginAndSave()`, `checkLoginAndLoad()`, `checkLoginAndEdit()`
- **Dependencies**: `api/list_user_collections.php`, `api/load_collection_tabs.php`

### Main Layout Template (`main_layout.php`)
- **Location**: `lupo-includes/ui/layouts/main_layout.php`
- **Features**:
  - Decorative border frame system (9-part border)
  - Collections dropdown integration
  - AJAX-loaded collection tabs
  - Bottom action bar with navigation icons
  - Shortcut and contents dropdowns in top border
- **CSS**: Inline styles for border frame, dropdowns, action bar
- **JavaScript**: Tab loading, collection management, modal handling

### Content Controller Collection Tab Handler (`content_handle_collection_tab()`)
- **Location**: `lupo-includes/modules/content/content-controller.php`
- **Function**: Handles `/collection/{id}/tab/{slug}` routes for content items
- **Features**:
  - Loads tab by slug from `lupo_collection_tabs`
  - Loads content items from `lupo_collection_tab_map` where `item_type = 'content'`
  - Renders content list with links
  - Loads collection tabs for navigation context
- **Dependencies**: `load_collection_tabs()`, `get_collection_name()`

### Collection Tabs Loader (`load_collection_tabs()`)
- **Location**: `lupo-includes/functions/collection-tabs-loader.php`
- **Changes**: Now loads child tabs recursively
- **Features**:
  - Loads root-level tabs (where `collection_tab_parent_id IS NULL`)
  - For each root tab, loads child tabs (where `collection_tab_parent_id = parent_tab_id`)
  - Stores children in array with `_slug` metadata
  - Returns properly structured tabs data

---

## Routing Changes

### Collection Tab Routes

**Before 4.0.18:**
- `/collection/{id}/tab/{slug}` → Always routed to TRUTH controller

**After 4.0.18:**
- `/collection/{id}/tab/{slug}` → Tries content controller first, falls back to TRUTH controller
- Ensures tabs with content items route correctly

### Routing Priority

1. Content controller (`content_handle_collection_tab()`) - handles content items
2. TRUTH controller (`truth_handle_collection_tab()`) - handles TRUTH items (fallback)

---

## Backward Compatibility

- ✅ **Fully backward compatible** with 4.0.17
- ✅ **No breaking changes** to existing functionality
- ✅ **Legacy files preserved** - All compatibility shims maintained
- ✅ **Database unchanged** - No schema modifications required
- ✅ **API endpoints unchanged** - Existing endpoints continue to work

---

## Rollback Procedure

If you need to rollback to 4.0.17:

1. Restore UI components from backup:
   - `lupo-includes/ui/layouts/main_layout.php`
   - `lupo-includes/ui/components/topbar.php`
   - Remove `lupo-includes/ui/components/collections_dropdown.php` (if added)

2. Restore routing files from backup:
   - `lupo-includes/modules/module-loader.php`
   - `lupo-includes/modules/content/content-controller.php`

3. Restore function files from backup:
   - `lupo-includes/functions/collection-tabs-loader.php`

4. Restore version references:
   - `config/global_atoms.yaml` version references
   - `lupo-includes/version.php` version constants
   - `CHANGELOG.md` version entries

**Note:** No database rollback is needed since no schema changes were made.

---

## Known Issues

None at this time.

---

## Support

For issues or questions:
- Review this migration guide for integration details
- Check `CHANGELOG.md` for complete change list
- Test component rendering with browser developer tools
- Verify routing with collection tab URLs
- Check browser console for JavaScript errors

---

## Next Steps

After migration:
1. Test Collections dropdown functionality
2. Verify tab loading and counting works correctly
3. Test routing for content items in collection tabs
4. Validate decorative border frame displays correctly
5. Test Save/Load/Edit collection actions

---

**Migration Status:** ✅ Ready for Production  
**Risk Level:** Low (UI integration only, no schema changes)  
**Estimated Downtime:** None (No database changes required)

---

*Last Updated: January 15, 2026*  
*Version: 4.0.18*  
*Status: Published*  
*Author: GLOBAL_CURRENT_AUTHORS*
